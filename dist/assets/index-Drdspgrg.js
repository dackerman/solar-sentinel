(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))a(n);new MutationObserver(n=>{for(const i of n)if(i.type==="childList")for(const r of i.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&a(r)}).observe(document,{childList:!0,subtree:!0});function t(n){const i={};return n.integrity&&(i.integrity=n.integrity),n.referrerPolicy&&(i.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?i.credentials="include":n.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function a(n){if(n.ep)return;n.ep=!0;const i=t(n);fetch(n.href,i)}})();class F{constructor(){this.baseURL=""}async fetchWeatherData(e,t){const a=performance.now(),n=`${this.baseURL}/api/uv-today?lat=${e.lat}&lon=${e.lon}&date=${t}`,i=await fetch(n),r=performance.now(),o=Math.round(r-a);if(!i.ok)throw new Error(`Weather API failed: ${i.status}`);const s=i.headers.get("X-Cache-Status");return{...await i.json(),timing:{duration:o,cacheStatus:s||"unknown"}}}async fetchDailyData(e,t){const a=performance.now(),n=`${this.baseURL}/api/daily-summary?lat=${e.lat}&lon=${e.lon}&date=${t}`,i=await fetch(n),r=performance.now(),o=Math.round(r-a);if(!i.ok)throw new Error(`Daily API failed: ${i.status}`);const s=i.headers.get("X-Cache-Status");return{...await i.json(),timing:{duration:o,cacheStatus:s||"unknown"}}}async checkForUpdates(e,t,a){const n=performance.now(),i=`${this.baseURL}/api/uv-today/poll?lat=${e.lat}&lon=${e.lon}&date=${t}&timestamp=${a}`,r=await fetch(i),o=performance.now(),s=Math.round(o-n);if(!r.ok)throw new Error(`Poll API failed: ${r.status}`);return{...await r.json(),timing:{duration:s,cacheStatus:"unknown"}}}}class k{constructor(){this.DEFAULT_LOCATION={lat:40.7162,lon:-74.3625,name:"Summit, NJ",isUserLocation:!1},this.LOCATION_CACHE_KEY="solar_sentinel_location",this.CACHE_DURATION_MS=24*60*60*1e3}getCachedLocation(){try{const e=localStorage.getItem(this.LOCATION_CACHE_KEY);if(!e)return null;const t=JSON.parse(e),n=Date.now()-t.timestamp;return n>this.CACHE_DURATION_MS?(console.log(`Location cache expired (${Math.round(n/1e3/60/60)}h old)`),localStorage.removeItem(this.LOCATION_CACHE_KEY),null):(console.log(`Location cache hit (${Math.round(n/1e3/60)}min old)`),{lat:t.lat,lon:t.lon,name:t.name,isUserLocation:!0})}catch(e){return console.log("Location cache error:",e),null}}setCachedLocation(e){try{const t={lat:e.lat,lon:e.lon,name:e.name,timestamp:Date.now()};localStorage.setItem(this.LOCATION_CACHE_KEY,JSON.stringify(t)),console.log(`Location cached: ${e.name}`)}catch(t){console.log("Location cache error:",t)}}async getCurrentLocation(){if(!navigator.geolocation)return console.log("Geolocation not supported"),null;const e=performance.now();return new Promise(t=>{const a={enableHighAccuracy:!0,timeout:1e4,maximumAge:3e5};navigator.geolocation.getCurrentPosition(async n=>{const i=await this.getLocationName(n.coords.latitude,n.coords.longitude),r=performance.now(),o=Math.round(r-e);console.log(`Geolocation obtained in ${o}ms`);const s={lat:n.coords.latitude,lon:n.coords.longitude,name:i,isUserLocation:!0};this.setCachedLocation(s),t(s)},n=>{const i=performance.now(),r=Math.round(i-e);console.log(`Geolocation error after ${r}ms:`,n.message),t(null)},a)})}getDefaultLocation(){return{...this.DEFAULT_LOCATION}}async getLocationName(e,t){const a=performance.now();try{const n=await fetch(`https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${e}&longitude=${t}&localityLanguage=en`),i=performance.now(),r=Math.round(i-a),o=await n.json();return console.log(`Geocoding completed in ${r}ms`),o.city&&o.principalSubdivision?`${o.city}, ${o.principalSubdivision}`:o.locality&&o.principalSubdivision?`${o.locality}, ${o.principalSubdivision}`:o.countryName?o.countryName:"Your Location"}catch(n){const i=performance.now(),r=Math.round(i-a);return console.log(`Geocoding error after ${r}ms:`,n),"Your Location"}}}class U{constructor(e){this.container=e,this.entries=[],this.isVisible=!1,this.maxEntries=50,this.setupPanel()}setupPanel(){var t;const e=document.createElement("div");e.id="debug-panel",e.className="hidden bg-gray-900 text-green-400 p-4 mb-4 rounded-lg font-mono text-xs max-h-64 overflow-y-auto",e.innerHTML=`
      <div class="flex justify-between items-center mb-2">
        <h4 class="text-green-300 font-semibold">Request Debug Log</h4>
        <button id="clear-debug" class="text-red-400 hover:text-red-300">Clear</button>
      </div>
      <div id="debug-log"></div>
    `,this.container.appendChild(e),(t=document.getElementById("clear-debug"))==null||t.addEventListener("click",()=>this.clear())}log(e,t){const n={timestamp:new Date().toLocaleTimeString(),message:e,data:t};this.entries.push(n),this.entries.length>this.maxEntries&&this.entries.shift(),this.updateDisplay()}toggle(){this.isVisible=!this.isVisible;const e=document.getElementById("debug-panel");e==null||e.classList.toggle("hidden",!this.isVisible),this.updateDisplay()}clear(){this.entries=[],this.updateDisplay()}updateDisplay(){if(!this.isVisible)return;const e=document.getElementById("debug-log");e&&(e.innerHTML=this.entries.map(t=>{let a="";return t.data&&(typeof t.data=="object"?a=" | "+JSON.stringify(t.data,null,0):a=" | "+t.data),`<div class="mb-1">[${t.timestamp}] ${t.message}${a}</div>`}).join(""),e.scrollTop=e.scrollHeight)}}function D(l){return l<=2?"#22c55e":l<=5?"#eab308":l<=7?"#f97316":l<=10?"#ef4444":"#8b5cf6"}function E(l){return l<=32?"#3b82f6":l<=50?"#60a5fa":l<74?"#10b981":l<85?"#f97316":l<95?"#ef4444":"#dc2626"}function O(l,e){return new Chart(l.getContext("2d"),{type:"bar",data:{labels:e.labels,datasets:[{label:"UV Index",data:e.uv,backgroundColor:e.uv.map(t=>D(t)),borderColor:e.uv.map(t=>D(t)),borderWidth:1,borderRadius:4,borderSkipped:!1},{label:"UV Index Clear Sky",data:e.uvClearSky,type:"line",borderColor:"#ef4444",backgroundColor:"transparent",borderWidth:2,borderDash:[5,5],fill:!1,pointRadius:0,tension:.3}]},options:{responsive:!1,maintainAspectRatio:!1,animation:!1,plugins:{legend:{display:!0,position:"top",labels:{usePointStyle:!0,padding:10,font:{size:window.innerWidth<640?10:12}}},tooltip:{callbacks:{label:function(t){const a=t.parsed.y;let n="Low";a>10?n="Extreme":a>7?n="Very High":a>5?n="High":a>2&&(n="Moderate");const i=t.dataset.label.includes("Clear Sky")?" (Clear Sky)":"";return`${t.dataset.label}: ${a} (${n})${i}`}}}},scales:{y:{beginAtZero:!0,max:Math.max(12,Math.max(...e.uv)+1),title:{display:window.innerWidth>=640,text:"UV Index"}},x:{title:{display:!1},ticks:{maxRotation:window.innerWidth<640?45:0,callback:function(t,a){return window.innerWidth<640?a%2===0?this.getLabelForValue(t):"":this.getLabelForValue(t)}}}}}})}function W(l,e){return new Chart(l.getContext("2d"),{type:"line",data:{labels:e.labels,datasets:[{label:"Precipitation Probability (%)",data:e.precipitation,borderColor:"#3b82f6",backgroundColor:"rgba(59, 130, 246, 0.2)",borderWidth:2,fill:!0,tension:.3,yAxisID:"y"},{label:"Cloud Cover (%)",data:e.cloudCover,type:"bar",borderColor:"#d1d5db",backgroundColor:"rgba(209, 213, 219, 0.6)",borderWidth:1,yAxisID:"y"},{label:"Temperature (°F)",data:e.temperature,borderColor:"#9ca3af",backgroundColor:"transparent",borderWidth:3,fill:!1,tension:.3,pointRadius:0,segment:{borderColor:t=>{var r,o,s,c;const a=(o=(r=t.p0)==null?void 0:r.parsed)==null?void 0:o.y,n=(c=(s=t.p1)==null?void 0:s.parsed)==null?void 0:c.y;if(typeof a!="number"||typeof n!="number")return;const i=(a+n)/2;return E(i)}},yAxisID:"y1"},{label:"Apparent Temperature (°F)",data:e.apparentTemperature,borderColor:"#6b7280",backgroundColor:"transparent",borderWidth:2,borderDash:[5,5],fill:!1,tension:.3,pointRadius:0,segment:{borderColor:t=>{var r,o,s,c;const a=(o=(r=t.p0)==null?void 0:r.parsed)==null?void 0:o.y,n=(c=(s=t.p1)==null?void 0:s.parsed)==null?void 0:c.y;if(typeof a!="number"||typeof n!="number")return;const i=(a+n)/2;return E(i)}},yAxisID:"y1"},{label:"Humidity (%)",data:e.humidity,borderColor:"#10b981",backgroundColor:"transparent",borderWidth:2,borderDash:[2,2],fill:!1,tension:.3,yAxisID:"y"}]},options:{responsive:!1,maintainAspectRatio:!1,animation:!1,plugins:{legend:{display:!0,position:"top"},tooltip:{mode:"index",intersect:!1}},scales:{y:{type:"linear",display:!0,position:"left",beginAtZero:!0,max:100,title:{display:window.innerWidth>=640,text:"Percentage"}},y1:{type:"linear",display:!0,position:"right",title:{display:window.innerWidth>=640,text:"Temperature (°F)"},grid:{drawOnChartArea:!1}},x:{title:{display:!1},ticks:{maxRotation:window.innerWidth<640?45:0,callback:function(t,a){return window.innerWidth<640?a%2===0?this.getLabelForValue(t):"":this.getLabelForValue(t)}}}}}})}class N{constructor(){this.api=new F,this.locationService=new k,this.currentLocation=this.locationService.getDefaultLocation(),this.currentDate=new Date().toLocaleDateString("en-CA"),this.uvChart=null,this.weatherChart=null,this.refreshTimer=null,this.refreshInFlight=!1,this.REFRESH_INTERVAL_MS=30*60*1e3}async initialize(){this.debugPanel=new U(document.body),this.setupEventListeners(),await this.loadData(),this.scheduleAutoRefresh()}setupEventListeners(){var t,a;const e=document.getElementById("debug-btn");e==null||e.addEventListener("click",()=>this.debugPanel.toggle()),(t=document.getElementById("prev-day"))==null||t.addEventListener("click",()=>this.navigateDate(-1)),(a=document.getElementById("next-day"))==null||a.addEventListener("click",()=>this.navigateDate(1))}async loadData(e=!1){var a,n,i,r,o,s,c,d,h,p,w,v,f,L,y;const t=e?"auto-refresh":"user-initiated";this.debugPanel.log(`Loading UV data for ${this.currentDate}`,{reason:t});try{const m=this.locationService.getCachedLocation();m?(this.currentLocation=m,this.debugPanel.log("Location: cache hit (0ms)",{name:m.name,coords:`${m.lat.toFixed(4)}, ${m.lon.toFixed(4)}`,source:"localStorage"})):this.debugPanel.log("Location: cache miss",{fallback:this.currentLocation.name,source:"default"});const b=performance.now();this.locationService.getCurrentLocation().then(g=>{const $=performance.now(),C=Math.round($-b);if(g){const T=Math.abs(g.lat-this.currentLocation.lat),P=Math.abs(g.lon-this.currentLocation.lon);T>.001||P>.001?(this.debugPanel.log(`Location updated (${C}ms)`,{name:g.name,coords:`${g.lat.toFixed(4)}, ${g.lon.toFixed(4)}`,duration:C,changed:!0}),this.currentLocation=g,this.loadData(!0)):this.debugPanel.log(`Location confirmed (${C}ms)`,{name:g.name,coords:`${g.lat.toFixed(4)}, ${g.lon.toFixed(4)}`,duration:C,changed:!1})}else this.debugPanel.log(`Location failed (${C}ms)`,{fallback:this.currentLocation.name,duration:C})});const I=this.currentLocation.isUserLocation?"📍 ":"",x=document.getElementById("location-display");x&&(x.textContent=`${I}${this.currentLocation.name}`);const u=await this.api.fetchWeatherData(this.currentLocation,this.currentDate),A=((a=u.timing)==null?void 0:a.cacheStatus)||((n=u.metadata)!=null&&n.cached?"hit":"miss");this.debugPanel.log(`UV API response: ${A} (${(i=u.timing)==null?void 0:i.duration}ms)`,{cached:(r=u.metadata)==null?void 0:r.cached,cacheAge:(o=u.metadata)==null?void 0:o.cacheAge,lastUpdated:(s=u.metadata)==null?void 0:s.lastUpdated,duration:(c=u.timing)==null?void 0:c.duration}),e||((d=document.getElementById("loading"))==null||d.style.setProperty("display","none"),(h=document.getElementById("current-conditions"))==null||h.classList.remove("hidden"),(p=document.getElementById("chart-container"))==null||p.classList.remove("hidden"),(w=document.getElementById("weather-chart-container"))==null||w.classList.remove("hidden"),(v=document.getElementById("legend"))==null||v.classList.remove("hidden"));const M=new Date(u.date+"T00:00:00").toLocaleDateString("en-US",{weekday:"long",month:"long",day:"numeric"}),S=document.getElementById("date-display");if(S&&(S.textContent=M),(f=u.metadata)!=null&&f.lastUpdated){const $=new Date(u.metadata.lastUpdated).toLocaleTimeString("en-US",{hour:"numeric",minute:"2-digit",hour12:!0});this.updateElement("current-time",`Last updated: ${$}`)}this.updateCurrentConditions(u),this.renderCharts(u)}catch(m){if(this.debugPanel.log("Load error",{error:m.message}),!e){(L=document.getElementById("loading"))==null||L.style.setProperty("display","none"),(y=document.getElementById("error"))==null||y.classList.remove("hidden");const b=document.getElementById("error-message");b&&(b.textContent=m.message)}}}updateCurrentConditions(e){var n,i,r,o;const t=new Date().toLocaleDateString("en-CA");if(this.currentDate===t){(n=document.getElementById("dual-display"))==null||n.classList.remove("hidden"),(i=document.getElementById("single-display"))==null||i.classList.add("hidden");const c=new Date().getHours();let d=0;for(let f=0;f<e.labels.length;f++){const L=e.labels[f],y=parseInt(L.split(":")[0]),m=L.includes("PM"),b=m&&y!==12?y+12:!m&&y===12?0:y;if(b===c){d=f;break}else if(b>c){d=Math.max(0,f-1);break}}const h=Math.round(e.temperature[d]||0),p=(e.uv[d]||0).toFixed(1),w=Math.round(e.precipitation[d]||0),v=Math.round(e.humidity[d]||0);this.updateElement("current-temp-dual",`${h}°F`),this.updateElement("current-uv-dual",p),this.updateElement("current-precip-dual",`${w}%`),this.updateElement("current-humidity-dual",`${v}%`),this.setElementColor("current-uv-dual",D(parseFloat(p))),this.setElementColor("current-temp-dual",E(h)),this.updateTodaysForecast()}else(r=document.getElementById("dual-display"))==null||r.classList.add("hidden"),(o=document.getElementById("single-display"))==null||o.classList.remove("hidden"),this.updateDailySummary()}async updateTodaysForecast(){var e,t,a,n,i,r;try{const o=await this.api.fetchDailyData(this.currentLocation,this.currentDate),s=((e=o.timing)==null?void 0:e.cacheStatus)||((t=o.metadata)!=null&&t.cached?"hit":"miss");this.debugPanel.log(`Daily API response: ${s} (${(a=o.timing)==null?void 0:a.duration}ms)`,{cached:(n=o.metadata)==null?void 0:n.cached,cacheAge:(i=o.metadata)==null?void 0:i.cacheAge,duration:(r=o.timing)==null?void 0:r.duration});const c=Math.round(o.tempMax||0),d=Math.round(o.tempMin||0),h=(o.uvMax||0).toFixed(1),p=Math.round(o.precipMax||0);this.updateElement("today-temp-dual",`${c}°/${d}°F`),this.updateElement("today-uv-dual",h),this.updateElement("today-precip-dual",`${p}%`),this.setElementColor("today-uv-dual",D(parseFloat(h))),this.setElementColor("today-temp-dual",E(c))}catch(o){this.debugPanel.log("Today forecast error",{error:o.message})}}async updateDailySummary(){var e,t,a,n,i,r;try{const o=await this.api.fetchDailyData(this.currentLocation,this.currentDate),s=((e=o.timing)==null?void 0:e.cacheStatus)||((t=o.metadata)!=null&&t.cached?"hit":"miss");this.debugPanel.log(`Daily summary API: ${s} (${(a=o.timing)==null?void 0:a.duration}ms)`,{cached:(n=o.metadata)==null?void 0:n.cached,cacheAge:(i=o.metadata)==null?void 0:i.cacheAge,duration:(r=o.timing)==null?void 0:r.duration});const c=Math.round(o.tempMax||0),d=Math.round(o.tempMin||0),h=(o.uvMax||0).toFixed(1),p=Math.round(o.precipMax||0),w=Math.round(o.humidityMax||0);this.updateElement("current-temp",`${c}°/${d}°F`),this.updateElement("current-uv",h),this.updateElement("current-precip",`${p}%`),this.updateElement("current-humidity",`${w}%`),this.setElementColor("current-uv",D(parseFloat(h))),this.setElementColor("current-temp",E(c))}catch(o){this.debugPanel.log("Daily summary error",{error:o.message})}}renderCharts(e){this.uvChart&&this.uvChart.destroy(),this.weatherChart&&this.weatherChart.destroy();const t=document.getElementById("uvChart"),a=document.getElementById("weatherChart");t&&a&&(t.style.width="100%",t.style.height="384px",t.width=t.offsetWidth,t.height=384,a.style.width="100%",a.style.height="384px",a.width=a.offsetWidth,a.height=384,this.uvChart=O(t,e),this.weatherChart=W(a,e))}scheduleAutoRefresh(){this.refreshTimer&&clearInterval(this.refreshTimer),this.debugPanel.log("Scheduled 30-min auto-refresh timer"),this.refreshTimer=window.setInterval(async()=>{const e=new Date().toLocaleDateString("en-CA");if(this.currentDate===e&&(this.currentDate=e),this.refreshInFlight){this.debugPanel.log("Auto-refresh skipped: request in flight");return}this.refreshInFlight=!0;try{this.debugPanel.log("30-min auto-refresh triggered"),await this.loadData(!0)}finally{this.refreshInFlight=!1}},this.REFRESH_INTERVAL_MS)}navigateDate(e){const[t,a,n]=this.currentDate.split("-").map(Number),i=new Date(t,a-1,n);i.setDate(i.getDate()+e);const r=new Date;r.setHours(0,0,0,0);const o=new Date(r);if(o.setDate(o.getDate()+16),i>=r&&i<=o){const s=i.toLocaleDateString("en-CA");this.debugPanel.log(`Date navigation: ${this.currentDate} → ${s}`,{direction:e}),this.currentDate=s,this.loadData()}}updateElement(e,t){const a=document.getElementById(e);a&&(a.textContent=t)}setElementColor(e,t){const a=document.getElementById(e);a&&(a.style.color=t)}}document.addEventListener("DOMContentLoaded",()=>{new N().initialize().catch(console.error)});"serviceWorker"in navigator&&window.addEventListener("load",()=>{navigator.serviceWorker.register("/sw.js").then(l=>{console.log("SW registered: ",l)}).catch(l=>{console.log("SW registration failed: ",l)})});
