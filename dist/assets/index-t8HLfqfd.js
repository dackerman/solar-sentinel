(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))a(i);new MutationObserver(i=>{for(const o of i)if(o.type==="childList")for(const r of o.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&a(r)}).observe(document,{childList:!0,subtree:!0});function t(i){const o={};return i.integrity&&(o.integrity=i.integrity),i.referrerPolicy&&(o.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?o.credentials="include":i.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function a(i){if(i.ep)return;i.ep=!0;const o=t(i);fetch(i.href,o)}})();class M{constructor(){this.baseURL=""}async fetchWeatherData(e,t){const a=performance.now(),i=`${this.baseURL}/api/uv-today?lat=${e.lat}&lon=${e.lon}&date=${t}`,o=await fetch(i),r=performance.now(),n=Math.round(r-a);if(!o.ok)throw new Error(`Weather API failed: ${o.status}`);const l=o.headers.get("X-Cache-Status");return{...await o.json(),timing:{duration:n,cacheStatus:l||"unknown"}}}async fetchDailyData(e,t){const a=performance.now(),i=`${this.baseURL}/api/daily-summary?lat=${e.lat}&lon=${e.lon}&date=${t}`,o=await fetch(i),r=performance.now(),n=Math.round(r-a);if(!o.ok)throw new Error(`Daily API failed: ${o.status}`);const l=o.headers.get("X-Cache-Status");return{...await o.json(),timing:{duration:n,cacheStatus:l||"unknown"}}}async checkForUpdates(e,t,a){const i=performance.now(),o=`${this.baseURL}/api/uv-today/poll?lat=${e.lat}&lon=${e.lon}&date=${t}&timestamp=${a}`,r=await fetch(o),n=performance.now(),l=Math.round(n-i);if(!r.ok)throw new Error(`Poll API failed: ${r.status}`);return{...await r.json(),timing:{duration:l,cacheStatus:"unknown"}}}}class A{constructor(){this.DEFAULT_LOCATION={lat:40.7162,lon:-74.3625,name:"Summit, NJ",isUserLocation:!1}}async getCurrentLocation(){if(!navigator.geolocation)return console.log("Geolocation not supported"),null;const e=performance.now();return new Promise(t=>{const a={enableHighAccuracy:!0,timeout:1e4,maximumAge:3e5};navigator.geolocation.getCurrentPosition(async i=>{const o=await this.getLocationName(i.coords.latitude,i.coords.longitude),r=performance.now(),n=Math.round(r-e);console.log(`Geolocation obtained in ${n}ms`),t({lat:i.coords.latitude,lon:i.coords.longitude,name:o,isUserLocation:!0})},i=>{const o=performance.now(),r=Math.round(o-e);console.log(`Geolocation error after ${r}ms:`,i.message),t(null)},a)})}getDefaultLocation(){return{...this.DEFAULT_LOCATION}}async getLocationName(e,t){const a=performance.now();try{const i=await fetch(`https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${e}&longitude=${t}&localityLanguage=en`),o=performance.now(),r=Math.round(o-a),n=await i.json();return console.log(`Geocoding completed in ${r}ms`),n.city&&n.principalSubdivision?`${n.city}, ${n.principalSubdivision}`:n.locality&&n.principalSubdivision?`${n.locality}, ${n.principalSubdivision}`:n.countryName?n.countryName:"Your Location"}catch(i){const o=performance.now(),r=Math.round(o-a);return console.log(`Geocoding error after ${r}ms:`,i),"Your Location"}}}class P{constructor(e){this.container=e,this.entries=[],this.isVisible=!1,this.maxEntries=50,this.setupPanel()}setupPanel(){var t;const e=document.createElement("div");e.id="debug-panel",e.className="hidden bg-gray-900 text-green-400 p-4 mb-4 rounded-lg font-mono text-xs max-h-64 overflow-y-auto",e.innerHTML=`
      <div class="flex justify-between items-center mb-2">
        <h4 class="text-green-300 font-semibold">Request Debug Log</h4>
        <button id="clear-debug" class="text-red-400 hover:text-red-300">Clear</button>
      </div>
      <div id="debug-log"></div>
    `,this.container.appendChild(e),(t=document.getElementById("clear-debug"))==null||t.addEventListener("click",()=>this.clear())}log(e,t){const i={timestamp:new Date().toLocaleTimeString(),message:e,data:t};this.entries.push(i),this.entries.length>this.maxEntries&&this.entries.shift(),this.updateDisplay()}toggle(){this.isVisible=!this.isVisible;const e=document.getElementById("debug-panel");e==null||e.classList.toggle("hidden",!this.isVisible),this.updateDisplay()}clear(){this.entries=[],this.updateDisplay()}updateDisplay(){if(!this.isVisible)return;const e=document.getElementById("debug-log");e&&(e.innerHTML=this.entries.map(t=>{let a="";return t.data&&(typeof t.data=="object"?a=" | "+JSON.stringify(t.data,null,0):a=" | "+t.data),`<div class="mb-1">[${t.timestamp}] ${t.message}${a}</div>`}).join(""),e.scrollTop=e.scrollHeight)}}function w(s){return s<=2?"#22c55e":s<=5?"#eab308":s<=7?"#f97316":s<=10?"#ef4444":"#8b5cf6"}function v(s){return s<=32?"#3b82f6":s<=50?"#60a5fa":s<74?"#10b981":s<85?"#f97316":s<95?"#ef4444":"#dc2626"}function T(s,e){return new Chart(s.getContext("2d"),{type:"bar",data:{labels:e.labels,datasets:[{label:"UV Index",data:e.uv,backgroundColor:e.uv.map(t=>w(t)),borderColor:e.uv.map(t=>w(t)),borderWidth:1,borderRadius:4,borderSkipped:!1},{label:"UV Index Clear Sky",data:e.uvClearSky,type:"line",borderColor:"#ef4444",backgroundColor:"transparent",borderWidth:2,borderDash:[5,5],fill:!1,pointRadius:0,tension:.3}]},options:{responsive:!1,maintainAspectRatio:!1,animation:!1,plugins:{legend:{display:!0,position:"top",labels:{usePointStyle:!0,padding:10,font:{size:window.innerWidth<640?10:12}}},tooltip:{callbacks:{label:function(t){const a=t.parsed.y;let i="Low";a>10?i="Extreme":a>7?i="Very High":a>5?i="High":a>2&&(i="Moderate");const o=t.dataset.label.includes("Clear Sky")?" (Clear Sky)":"";return`${t.dataset.label}: ${a} (${i})${o}`}}}},scales:{y:{beginAtZero:!0,max:Math.max(12,Math.max(...e.uv)+1),title:{display:window.innerWidth>=640,text:"UV Index"}},x:{title:{display:!1},ticks:{maxRotation:window.innerWidth<640?45:0,callback:function(t,a){return window.innerWidth<640?a%2===0?this.getLabelForValue(t):"":this.getLabelForValue(t)}}}}}})}function k(s,e){return new Chart(s.getContext("2d"),{type:"line",data:{labels:e.labels,datasets:[{label:"Precipitation Probability (%)",data:e.precipitation,borderColor:"#3b82f6",backgroundColor:"rgba(59, 130, 246, 0.2)",borderWidth:2,fill:!0,tension:.3,yAxisID:"y"},{label:"Cloud Cover (%)",data:e.cloudCover,type:"bar",borderColor:"#d1d5db",backgroundColor:"rgba(209, 213, 219, 0.6)",borderWidth:1,yAxisID:"y"},{label:"Temperature (¬∞F)",data:e.temperature,borderColor:"#9ca3af",backgroundColor:"transparent",borderWidth:3,fill:!1,tension:.3,pointRadius:0,segment:{borderColor:t=>{var r,n,l,d;const a=(n=(r=t.p0)==null?void 0:r.parsed)==null?void 0:n.y,i=(d=(l=t.p1)==null?void 0:l.parsed)==null?void 0:d.y;if(typeof a!="number"||typeof i!="number")return;const o=(a+i)/2;return v(o)}},yAxisID:"y1"},{label:"Apparent Temperature (¬∞F)",data:e.apparentTemperature,borderColor:"#6b7280",backgroundColor:"transparent",borderWidth:2,borderDash:[5,5],fill:!1,tension:.3,pointRadius:0,segment:{borderColor:t=>{var r,n,l,d;const a=(n=(r=t.p0)==null?void 0:r.parsed)==null?void 0:n.y,i=(d=(l=t.p1)==null?void 0:l.parsed)==null?void 0:d.y;if(typeof a!="number"||typeof i!="number")return;const o=(a+i)/2;return v(o)}},yAxisID:"y1"},{label:"Humidity (%)",data:e.humidity,borderColor:"#10b981",backgroundColor:"transparent",borderWidth:2,borderDash:[2,2],fill:!1,tension:.3,yAxisID:"y"}]},options:{responsive:!1,maintainAspectRatio:!1,animation:!1,plugins:{legend:{display:!0,position:"top"},tooltip:{mode:"index",intersect:!1}},scales:{y:{type:"linear",display:!0,position:"left",beginAtZero:!0,max:100,title:{display:window.innerWidth>=640,text:"Percentage"}},y1:{type:"linear",display:!0,position:"right",title:{display:window.innerWidth>=640,text:"Temperature (¬∞F)"},grid:{drawOnChartArea:!1}},x:{title:{display:!1},ticks:{maxRotation:window.innerWidth<640?45:0,callback:function(t,a){return window.innerWidth<640?a%2===0?this.getLabelForValue(t):"":this.getLabelForValue(t)}}}}}})}class F{constructor(){this.api=new M,this.locationService=new A,this.currentLocation=this.locationService.getDefaultLocation(),this.currentDate=new Date().toLocaleDateString("en-CA"),this.uvChart=null,this.weatherChart=null,this.refreshTimer=null,this.refreshInFlight=!1,this.REFRESH_INTERVAL_MS=30*60*1e3}async initialize(){this.debugPanel=new P(document.body),this.setupEventListeners(),await this.loadData(),this.scheduleAutoRefresh()}setupEventListeners(){var t,a;const e=document.getElementById("debug-btn");e==null||e.addEventListener("click",()=>this.debugPanel.toggle()),(t=document.getElementById("prev-day"))==null||t.addEventListener("click",()=>this.navigateDate(-1)),(a=document.getElementById("next-day"))==null||a.addEventListener("click",()=>this.navigateDate(1))}async loadData(e=!1){var a,i,o,r,n,l,d,c,u,p,y,D,f,b;const t=e?"auto-refresh":"user-initiated";this.debugPanel.log(`Loading UV data for ${this.currentDate}`,{reason:t});try{const g=performance.now(),h=await this.locationService.getCurrentLocation(),L=performance.now(),C=Math.round(L-g);h?(this.currentLocation=h,this.debugPanel.log(`Location obtained (${C}ms)`,{name:h.name,coords:`${h.lat.toFixed(4)}, ${h.lon.toFixed(4)}`,duration:C})):this.debugPanel.log(`Location failed (${C}ms)`,{fallback:this.currentLocation.name,duration:C});const $=this.currentLocation.isUserLocation?"üìç ":"",E=document.getElementById("location-display");E&&(E.textContent=`${$}${this.currentLocation.name}`);const m=await this.api.fetchWeatherData(this.currentLocation,this.currentDate),I=((a=m.timing)==null?void 0:a.cacheStatus)||((i=m.metadata)!=null&&i.cached?"hit":"miss");this.debugPanel.log(`UV API response: ${I} (${(o=m.timing)==null?void 0:o.duration}ms)`,{cached:(r=m.metadata)==null?void 0:r.cached,cacheAge:(n=m.metadata)==null?void 0:n.cacheAge,lastUpdated:(l=m.metadata)==null?void 0:l.lastUpdated,duration:(d=m.timing)==null?void 0:d.duration}),e||((c=document.getElementById("loading"))==null||c.style.setProperty("display","none"),(u=document.getElementById("current-conditions"))==null||u.classList.remove("hidden"),(p=document.getElementById("chart-container"))==null||p.classList.remove("hidden"),(y=document.getElementById("weather-chart-container"))==null||y.classList.remove("hidden"),(D=document.getElementById("legend"))==null||D.classList.remove("hidden"));const S=new Date(m.date+"T00:00:00").toLocaleDateString("en-US",{weekday:"long",month:"long",day:"numeric"}),x=document.getElementById("date-display");x&&(x.textContent=S),this.updateCurrentConditions(m),this.renderCharts(m)}catch(g){if(this.debugPanel.log("Load error",{error:g.message}),!e){(f=document.getElementById("loading"))==null||f.style.setProperty("display","none"),(b=document.getElementById("error"))==null||b.classList.remove("hidden");const h=document.getElementById("error-message");h&&(h.textContent=g.message)}}}updateCurrentConditions(e){var i,o,r,n;const t=new Date().toLocaleDateString("en-CA");if(this.currentDate===t){(i=document.getElementById("dual-display"))==null||i.classList.remove("hidden"),(o=document.getElementById("single-display"))==null||o.classList.add("hidden");const d=new Date().getHours();let c=0;for(let f=0;f<e.labels.length;f++){const b=e.labels[f],g=parseInt(b.split(":")[0]),h=b.includes("PM"),L=h&&g!==12?g+12:!h&&g===12?0:g;if(L===d){c=f;break}else if(L>d){c=Math.max(0,f-1);break}}const u=Math.round(e.temperature[c]||0),p=(e.uv[c]||0).toFixed(1),y=Math.round(e.precipitation[c]||0),D=Math.round(e.humidity[c]||0);this.updateElement("current-temp-dual",`${u}¬∞F`),this.updateElement("current-uv-dual",p),this.updateElement("current-precip-dual",`${y}%`),this.updateElement("current-humidity-dual",`${D}%`),this.setElementColor("current-uv-dual",w(parseFloat(p))),this.setElementColor("current-temp-dual",v(u)),this.updateTodaysForecast()}else(r=document.getElementById("dual-display"))==null||r.classList.add("hidden"),(n=document.getElementById("single-display"))==null||n.classList.remove("hidden"),this.updateDailySummary()}async updateTodaysForecast(){var e,t,a,i,o,r;try{const n=await this.api.fetchDailyData(this.currentLocation,this.currentDate),l=((e=n.timing)==null?void 0:e.cacheStatus)||((t=n.metadata)!=null&&t.cached?"hit":"miss");this.debugPanel.log(`Daily API response: ${l} (${(a=n.timing)==null?void 0:a.duration}ms)`,{cached:(i=n.metadata)==null?void 0:i.cached,cacheAge:(o=n.metadata)==null?void 0:o.cacheAge,duration:(r=n.timing)==null?void 0:r.duration});const d=Math.round(n.tempMax||0),c=Math.round(n.tempMin||0),u=(n.uvMax||0).toFixed(1),p=Math.round(n.precipMax||0);this.updateElement("today-temp-dual",`${d}¬∞/${c}¬∞F`),this.updateElement("today-uv-dual",u),this.updateElement("today-precip-dual",`${p}%`),this.setElementColor("today-uv-dual",w(parseFloat(u))),this.setElementColor("today-temp-dual",v(d))}catch(n){this.debugPanel.log("Today forecast error",{error:n.message})}}async updateDailySummary(){var e,t,a,i,o,r;try{const n=await this.api.fetchDailyData(this.currentLocation,this.currentDate),l=((e=n.timing)==null?void 0:e.cacheStatus)||((t=n.metadata)!=null&&t.cached?"hit":"miss");this.debugPanel.log(`Daily summary API: ${l} (${(a=n.timing)==null?void 0:a.duration}ms)`,{cached:(i=n.metadata)==null?void 0:i.cached,cacheAge:(o=n.metadata)==null?void 0:o.cacheAge,duration:(r=n.timing)==null?void 0:r.duration});const d=Math.round(n.tempMax||0),c=Math.round(n.tempMin||0),u=(n.uvMax||0).toFixed(1),p=Math.round(n.precipMax||0),y=Math.round(n.humidityMax||0);this.updateElement("current-temp",`${d}¬∞/${c}¬∞F`),this.updateElement("current-uv",u),this.updateElement("current-precip",`${p}%`),this.updateElement("current-humidity",`${y}%`),this.setElementColor("current-uv",w(parseFloat(u))),this.setElementColor("current-temp",v(d))}catch(n){this.debugPanel.log("Daily summary error",{error:n.message})}}renderCharts(e){this.uvChart&&this.uvChart.destroy(),this.weatherChart&&this.weatherChart.destroy();const t=document.getElementById("uvChart"),a=document.getElementById("weatherChart");t&&a&&(t.style.width="100%",t.style.height="384px",t.width=t.offsetWidth,t.height=384,a.style.width="100%",a.style.height="384px",a.width=a.offsetWidth,a.height=384,this.uvChart=T(t,e),this.weatherChart=k(a,e))}scheduleAutoRefresh(){this.refreshTimer&&clearInterval(this.refreshTimer),this.debugPanel.log("Scheduled 30-min auto-refresh timer"),this.refreshTimer=window.setInterval(async()=>{const e=new Date().toLocaleDateString("en-CA");if(this.currentDate===e&&(this.currentDate=e),this.refreshInFlight){this.debugPanel.log("Auto-refresh skipped: request in flight");return}this.refreshInFlight=!0;try{this.debugPanel.log("30-min auto-refresh triggered"),await this.loadData(!0)}finally{this.refreshInFlight=!1}},this.REFRESH_INTERVAL_MS)}navigateDate(e){const[t,a,i]=this.currentDate.split("-").map(Number),o=new Date(t,a-1,i);o.setDate(o.getDate()+e);const r=new Date;r.setHours(0,0,0,0);const n=new Date(r);if(n.setDate(n.getDate()+16),o>=r&&o<=n){const l=o.toLocaleDateString("en-CA");this.debugPanel.log(`Date navigation: ${this.currentDate} ‚Üí ${l}`,{direction:e}),this.currentDate=l,this.loadData()}}updateElement(e,t){const a=document.getElementById(e);a&&(a.textContent=t)}setElementColor(e,t){const a=document.getElementById(e);a&&(a.style.color=t)}}document.addEventListener("DOMContentLoaded",()=>{new F().initialize().catch(console.error)});"serviceWorker"in navigator&&window.addEventListener("load",()=>{navigator.serviceWorker.register("/sw.js").then(s=>{console.log("SW registered: ",s)}).catch(s=>{console.log("SW registration failed: ",s)})});
