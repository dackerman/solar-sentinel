<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Solar Sentinel - UV Index Monitor</title>
    
    <!-- PWA Meta Tags -->
    <meta name="description" content="Real-time UV index monitoring with location detection">
    <meta name="theme-color" content="#3b82f6">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Solar Sentinel">
    <link rel="apple-touch-icon" href="/icon-192.png">
    <link rel="icon" type="image/png" sizes="192x192" href="/icon-192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="/icon-512.png">
    <link rel="manifest" href="/manifest.json">
    
    <link href="https://unpkg.com/tailwindcss@3.4.0/dist/tailwind.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <header class="text-center mb-8">
            <h1 class="text-3xl font-bold text-gray-800 mb-2">Solar Sentinel</h1>
            <p id="location-display" class="text-gray-600">UV Index Monitor - Getting location...</p>
        </header>

        <div class="max-w-4xl mx-auto">
            <!-- Loading state -->
            <div id="loading" class="text-center py-8">
                <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500"></div>
                <p class="mt-2 text-gray-600">Loading UV data...</p>
            </div>

            <!-- Error state -->
            <div id="error" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4">
                <p id="error-message"></p>
            </div>

            <!-- Weather Chart container -->
            <div id="weather-chart-container" class="hidden bg-white rounded-lg shadow-lg p-6 mb-6">
                <h3 class="text-lg font-semibold mb-4">Temperature & Precipitation</h3>
                <div style="height: 384px; width: 100%; position: relative;">
                    <canvas id="weatherChart" style="height: 384px !important; width: 100% !important;"></canvas>
                </div>
            </div>

            <!-- UV Chart container -->
            <div id="chart-container" class="hidden bg-white rounded-lg shadow-lg p-6">
                <h3 class="text-lg font-semibold mb-4">UV Index</h3>
                <div style="height: 384px; width: 100%; position: relative;">
                    <canvas id="uvChart" style="height: 384px !important; width: 100% !important;"></canvas>
                </div>
            </div>

            <!-- UV Index Legend -->
            <div id="legend" class="hidden mt-6 bg-white rounded-lg shadow-lg p-6">
                <h3 class="text-lg font-semibold mb-4">UV Index Scale</h3>
                <div class="grid grid-cols-2 md:grid-cols-5 gap-2 text-sm">
                    <div class="flex items-center">
                        <div class="w-4 h-4 bg-green-400 rounded mr-2"></div>
                        <span>0-2 Low</span>
                    </div>
                    <div class="flex items-center">
                        <div class="w-4 h-4 bg-yellow-400 rounded mr-2"></div>
                        <span>3-5 Moderate</span>
                    </div>
                    <div class="flex items-center">
                        <div class="w-4 h-4 bg-orange-400 rounded mr-2"></div>
                        <span>6-7 High</span>
                    </div>
                    <div class="flex items-center">
                        <div class="w-4 h-4 bg-red-500 rounded mr-2"></div>
                        <span>8-10 Very High</span>
                    </div>
                    <div class="flex items-center">
                        <div class="w-4 h-4 bg-purple-600 rounded mr-2"></div>
                        <span>11+ Extreme</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Default location (Summit, NJ)
        let currentLocation = {
            lat: 40.7162,
            lon: -74.3625,
            name: 'Summit, NJ'
        };

        async function getCurrentLocation() {
            return new Promise((resolve) => {
                if (!navigator.geolocation) {
                    console.log('Geolocation not supported');
                    resolve(null);
                    return;
                }

                const options = {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 300000 // 5 minutes
                };

                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        resolve({
                            lat: position.coords.latitude,
                            lon: position.coords.longitude,
                            name: 'Your Location'
                        });
                    },
                    (error) => {
                        console.log('Geolocation error:', error.message);
                        resolve(null);
                    },
                    options
                );
            });
        }

        async function loadUVData() {
            try {
                // Try to get user's location
                const userLocation = await getCurrentLocation();
                
                if (userLocation) {
                    currentLocation = userLocation;
                } else {
                    console.log('Using default location: Summit, NJ');
                }

                // Update location display
                document.getElementById('location-display').textContent = 
                    `UV Index Monitor - ${currentLocation.name}`;

                // Fetch UV data for current location
                const url = `/api/uv-today?lat=${currentLocation.lat}&lon=${currentLocation.lon}`;
                const response = await fetch(url);
                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Failed to load UV data');
                }

                // Hide loading, show charts
                document.getElementById('loading').style.display = 'none';
                document.getElementById('chart-container').classList.remove('hidden');
                document.getElementById('weather-chart-container').classList.remove('hidden');
                document.getElementById('legend').classList.remove('hidden');

                // UV Index color mapping
                function getUVColor(uvValue) {
                    if (uvValue <= 2) return '#22c55e';      // Green - Low
                    if (uvValue <= 5) return '#eab308';      // Yellow - Moderate  
                    if (uvValue <= 7) return '#f97316';      // Orange - High
                    if (uvValue <= 10) return '#ef4444';     // Red - Very High
                    return '#8b5cf6';                         // Purple - Extreme
                }

                // Create UV chart
                const uvCtx = document.getElementById('uvChart').getContext('2d');
                new Chart(uvCtx, {
                    type: 'bar',
                    data: {
                        labels: data.labels,
                        datasets: [{
                            label: 'UV Index',
                            data: data.uv,
                            backgroundColor: data.uv.map(value => getUVColor(value)),
                            borderColor: data.uv.map(value => getUVColor(value)),
                            borderWidth: 1,
                            borderRadius: 4,
                            borderSkipped: false
                        }]
                    },
                    options: {
                        responsive: false,
                        maintainAspectRatio: false,
                        animation: false,
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const value = context.parsed.y;
                                        let level = 'Low';
                                        if (value > 10) level = 'Extreme';
                                        else if (value > 7) level = 'Very High';
                                        else if (value > 5) level = 'High';
                                        else if (value > 2) level = 'Moderate';
                                        return `UV Index: ${value} (${level})`;
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: Math.max(12, Math.max(...data.uv) + 1),
                                title: {
                                    display: true,
                                    text: 'UV Index'
                                },
                                grid: {
                                    color: 'rgba(0, 0, 0, 0.1)'
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'Hour of Day'
                                },
                                grid: {
                                    color: 'rgba(0, 0, 0, 0.1)'
                                }
                            }
                        }
                    }
                });

                // Create weather chart (Temperature & Precipitation)
                const weatherCtx = document.getElementById('weatherChart').getContext('2d');
                new Chart(weatherCtx, {
                    type: 'line',
                    data: {
                        labels: data.labels,
                        datasets: [{
                            label: 'Precipitation Probability (%)',
                            data: data.precipitation,
                            borderColor: '#3b82f6',
                            backgroundColor: 'rgba(59, 130, 246, 0.2)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.3,
                            yAxisID: 'y'
                        }, {
                            label: 'Apparent Temperature (°F)',
                            data: data.temperature,
                            borderColor: '#f97316',
                            backgroundColor: 'rgba(249, 115, 22, 0.1)',
                            borderWidth: 3,
                            fill: false,
                            tension: 0.3,
                            yAxisID: 'y1'
                        }]
                    },
                    options: {
                        responsive: false,
                        maintainAspectRatio: false,
                        animation: false,
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top'
                            },
                            tooltip: {
                                mode: 'index',
                                intersect: false
                            }
                        },
                        scales: {
                            y: {
                                type: 'linear',
                                display: true,
                                position: 'left',
                                beginAtZero: true,
                                max: 100,
                                title: {
                                    display: true,
                                    text: 'Precipitation Probability (%)'
                                },
                                grid: {
                                    color: 'rgba(59, 130, 246, 0.1)'
                                }
                            },
                            y1: {
                                type: 'linear',
                                display: true,
                                position: 'right',
                                title: {
                                    display: true,
                                    text: 'Temperature (°F)'
                                },
                                grid: {
                                    drawOnChartArea: false
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'Hour of Day'
                                },
                                grid: {
                                    color: 'rgba(0, 0, 0, 0.1)'
                                }
                            }
                        }
                    }
                });

            } catch (error) {
                // Hide loading, show error
                document.getElementById('loading').style.display = 'none';
                document.getElementById('error').classList.remove('hidden');
                document.getElementById('error-message').textContent = error.message;
            }
        }

        // Register service worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then((registration) => {
                        console.log('SW registered: ', registration);
                    })
                    .catch((registrationError) => {
                        console.log('SW registration failed: ', registrationError);
                    });
            });
        }

        // Load data when page loads
        loadUVData();
    </script>
</body>
</html>