<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Solar Sentinel</title>
    
    <!-- PWA Meta Tags -->
    <meta name="description" content="Real-time UV index monitoring with location detection">
    <meta name="theme-color" content="#3b82f6">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Solar Sentinel">
    <link rel="apple-touch-icon" href="/icon-192.png">
    <link rel="icon" type="image/png" sizes="192x192" href="/icon-192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="/icon-512.png">
    <link rel="manifest" href="/manifest.json">
    
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="container mx-auto max-w-4xl">
        <header class="flex items-center justify-between">
            <img src="/logo.png" alt="Solar Sentinel" class="h-auto w-32 m-1">
            <div class="text-right">
                <div class="flex items-center justify-end mb-1">
                    <button id="prev-day" class="text-gray-600 hover:text-gray-800 mr-2 text-lg" title="Previous day">‚Üê</button>
                    <p id="date-display" class="text-gray-800 text-sm font-medium mx-2"></p>
                    <button id="next-day" class="text-gray-600 hover:text-gray-800 ml-2 text-lg" title="Next day">‚Üí</button>
                </div>
                <p id="location-display" class="text-gray-600 text-sm">üìç Getting location...</p>
            </div>
        </header>

        <div class="max-w-4xl mx-auto">
            <!-- Current Conditions -->
            <div id="current-conditions" class="hidden bg-white rounded-lg shadow-lg p-4 mb-6">
                <div class="flex justify-between items-center mb-3">
                    <h3 class="text-lg font-semibold">Current Conditions</h3>
                    <div class="text-sm text-gray-600">
                        <span id="current-time">--:-- --</span>
                    </div>
                </div>
                
                <!-- Dual Display: Current + Today's Forecast -->
                <div id="dual-display" class="hidden space-y-3">
                    <!-- Current Row -->
                    <div class="flex items-center justify-between bg-blue-50 rounded-lg p-3">
                        <div class="text-sm font-medium text-blue-800 w-12">Now:</div>
                        <div class="flex items-center space-x-4 text-sm">
                            <div class="flex items-center space-x-1">
                                <span>üå°Ô∏è</span>
                                <span id="current-temp-dual" class="font-semibold">--¬∞F</span>
                            </div>
                            <div class="flex items-center space-x-1">
                                <span>‚òÄÔ∏è</span>
                                <span id="current-uv-dual" class="font-semibold">--</span>
                            </div>
                            <div class="flex items-center space-x-1">
                                <span>üåßÔ∏è</span>
                                <span id="current-precip-dual" class="font-semibold">--%</span>
                            </div>
                            <div class="flex items-center space-x-1">
                                <span>üíß</span>
                                <span id="current-humidity-dual" class="font-semibold">--%</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Today's Forecast Row -->
                    <div class="flex items-center justify-between bg-green-50 rounded-lg p-3">
                        <div class="text-sm font-medium text-green-800 w-12">Today:</div>
                        <div class="flex items-center space-x-4 text-sm">
                            <div class="flex items-center space-x-1">
                                <span>üå°Ô∏è</span>
                                <span id="today-temp-dual" class="font-semibold">--¬∞/--¬∞F</span>
                            </div>
                            <div class="flex items-center space-x-1">
                                <span>‚òÄÔ∏è</span>
                                <span id="today-uv-dual" class="font-semibold">--</span>
                            </div>
                            <div class="flex items-center space-x-1">
                                <span>üåßÔ∏è</span>
                                <span id="today-precip-dual" class="font-semibold">--%</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Original Single Display (for future days) -->
                <div id="single-display" class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
                    <div class="bg-gray-50 rounded-lg p-3">
                        <div class="text-2xl mb-1">üå°Ô∏è</div>
                        <div id="current-temp" class="text-xl font-bold text-gray-800">--¬∞F</div>
                        <div id="temp-label" class="text-xs text-gray-600">Temperature</div>
                    </div>
                    <div class="bg-gray-50 rounded-lg p-3">
                        <div class="text-2xl mb-1">‚òÄÔ∏è</div>
                        <div id="current-uv" class="text-xl font-bold text-gray-800">--</div>
                        <div id="uv-label" class="text-xs text-gray-600">UV Index</div>
                    </div>
                    <div class="bg-gray-50 rounded-lg p-3">
                        <div class="text-2xl mb-1">üåßÔ∏è</div>
                        <div id="current-precip" class="text-xl font-bold text-gray-800">--%</div>
                        <div id="precip-label" class="text-xs text-gray-600">Precipitation</div>
                    </div>
                    <div class="bg-gray-50 rounded-lg p-3">
                        <div class="text-2xl mb-1">üíß</div>
                        <div id="current-humidity" class="text-xl font-bold text-gray-800">--%</div>
                        <div id="humidity-label" class="text-xs text-gray-600">Humidity</div>
                    </div>
                </div>
            </div>

            <!-- Loading state -->
            <div id="loading" class="text-center py-8">
                <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500"></div>
                <p class="mt-2 text-gray-600">Loading UV data...</p>
            </div>

            <!-- Error state -->
            <div id="error" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4">
                <p id="error-message"></p>
            </div>

            <!-- Weather Chart container -->
            <div id="weather-chart-container" class="hidden bg-white rounded-lg shadow-lg p-2 sm:p-6 mb-6">
                <h3 class="text-lg font-semibold mb-2 sm:mb-4">Weather Conditions</h3>
                <div class="text-xs text-gray-600 mb-2 sm:hidden flex justify-between">
                    <span>üåßÔ∏è Precip (%)</span>
                    <span>üå°Ô∏è Temp (¬∞F)</span>
                </div>
                <div class="text-xs text-gray-600 mb-2 sm:hidden flex justify-between">
                    <span>‚òÅÔ∏è Cloud (%)</span>
                    <span>üíß Humidity (%)</span>
                </div>
                <div style="height: 384px; width: 100%; position: relative;">
                    <canvas id="weatherChart" style="height: 384px !important; width: 100% !important;"></canvas>
                </div>
            </div>

            <!-- UV Chart container -->
            <div id="chart-container" class="hidden bg-white rounded-lg shadow-lg p-2 sm:p-6">
                <h3 class="text-lg font-semibold mb-2 sm:mb-4">UV Index</h3>
                <div class="text-xs text-gray-600 mb-2 sm:hidden">‚òÄÔ∏è UV Index Level</div>
                <div style="height: 384px; width: 100%; position: relative;">
                    <canvas id="uvChart" style="height: 384px !important; width: 100% !important;"></canvas>
                </div>
            </div>

            <!-- UV Index Legend -->
            <div id="legend" class="hidden mt-6 bg-white rounded-lg shadow-lg p-6">
                <h3 class="text-lg font-semibold mb-4">UV Index Scale</h3>
                <div class="grid grid-cols-2 md:grid-cols-5 gap-2 text-sm">
                    <div class="flex items-center">
                        <div class="w-4 h-4 bg-green-400 rounded mr-2"></div>
                        <span>0-2 Low</span>
                    </div>
                    <div class="flex items-center">
                        <div class="w-4 h-4 bg-yellow-400 rounded mr-2"></div>
                        <span>3-5 Moderate</span>
                    </div>
                    <div class="flex items-center">
                        <div class="w-4 h-4 bg-orange-400 rounded mr-2"></div>
                        <span>6-7 High</span>
                    </div>
                    <div class="flex items-center">
                        <div class="w-4 h-4 bg-red-500 rounded mr-2"></div>
                        <span>8-10 Very High</span>
                    </div>
                    <div class="flex items-center">
                        <div class="w-4 h-4 bg-purple-600 rounded mr-2"></div>
                        <span>11+ Extreme</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Default location (Summit, NJ)
        let currentLocation = {
            lat: 40.7162,
            lon: -74.3625,
            name: 'Summit, NJ',
            isUserLocation: false
        };

        // Current selected date (defaults to today)
        let currentDate = new Date().toLocaleDateString('en-CA'); // YYYY-MM-DD format

        // Chart instances (need to track for destruction)
        let weatherChart = null;
        let uvChart = null;
        
        // Current data timestamp for polling
        let currentDataTimestamp = 0;

        // UV Index color mapping
        function getUVColor(uvValue) {
            if (uvValue <= 2) return '#22c55e';      // Green - Low
            if (uvValue <= 5) return '#eab308';      // Yellow - Moderate  
            if (uvValue <= 7) return '#f97316';      // Orange - High
            if (uvValue <= 10) return '#ef4444';     // Red - Very High
            return '#8b5cf6';                         // Purple - Extreme
        }


        // Helper to map a temperature to a line color (matches band hues)
        function getTempLineColor(t) {
            if (t <= 32) return '#3b82f6';      // blue
            if (t <= 50) return '#60a5fa';      // light blue
            if (t < 74)  return '#10b981';      // green
            if (t < 85)  return '#f97316';      // orange
            if (t < 95)  return '#ef4444';      // red
            return '#dc2626';                   // deep red
        }

        // Set to true to force a neutral grey temperature line
        const USE_NEUTRAL_TEMP_LINE = false;

        // Function to fetch and update daily summary data
        async function updateDailySummary() {
            try {
                const url = `/api/daily-summary?lat=${currentLocation.lat}&lon=${currentLocation.lon}&date=${currentDate}`;
                const response = await fetch(url);
                const dailyData = await response.json();

                if (!response.ok) {
                    throw new Error(dailyData.error || 'Failed to load daily summary');
                }

                // Update conditions display with daily data
                const tempHigh = Math.round(dailyData.tempMax || 0);
                const tempLow = Math.round(dailyData.tempMin || 0);
                const uvMax = (dailyData.uvMax || 0).toFixed(1);
                const precipMax = Math.round(dailyData.precipMax || 0);
                const humidityMax = Math.round(dailyData.humidityMax || 0);

                document.getElementById('current-temp').textContent = `${tempHigh}¬∞/${tempLow}¬∞F`;
                document.getElementById('current-uv').textContent = uvMax;
                document.getElementById('current-precip').textContent = `${precipMax}%`;
                document.getElementById('current-humidity').textContent = `${humidityMax}%`;

                // Update labels for daily data
                document.getElementById('temp-label').textContent = 'High/Low';
                document.getElementById('uv-label').textContent = 'Peak UV';
                document.getElementById('precip-label').textContent = 'Max Precip';
                document.getElementById('humidity-label').textContent = 'Max Humidity';

                // Color the UV value based on level
                const uvElement = document.getElementById('current-uv');
                uvElement.style.color = getUVColor(parseFloat(uvMax));

                // Color the temperature based on thermal bands (use high temp)
                const tempElement = document.getElementById('current-temp');
                tempElement.style.color = getTempLineColor(tempHigh);

            } catch (error) {
                console.error('Daily summary error:', error);
                // Fallback to hourly data if daily fails
                updateCurrentConditions(lastHourlyData);
            }
        }

        // Store last hourly data for fallback
        let lastHourlyData = null;

        // Function to update current conditions display
        function updateCurrentConditions(data) {
            // Store for potential fallback
            lastHourlyData = data;
            
            // Check if we're viewing today's data
            const today = new Date().toLocaleDateString('en-CA'); // YYYY-MM-DD format
            const isToday = currentDate === today;
            
            // Update header and time display
            const headerElement = document.querySelector('#current-conditions h3');
            const now = new Date();
            
            if (isToday) {
                headerElement.textContent = 'Current Conditions';
                
                // Show dual display for today
                document.getElementById('dual-display').classList.remove('hidden');
                document.getElementById('single-display').classList.add('hidden');
                
                // Find current hour for time display
                const currentHour = now.getHours();
                let currentIndex = 0;
                let foundExactMatch = false;
                
                for (let i = 0; i < data.labels.length; i++) {
                    const label = data.labels[i];
                    const hour = parseInt(label.split(':')[0]);
                    const isPM = label.includes('PM');
                    const hour24 = isPM && hour !== 12 ? hour + 12 : (!isPM && hour === 12 ? 0 : hour);
                    
                    if (hour24 === currentHour) {
                        currentIndex = i;
                        foundExactMatch = true;
                        break;
                    } else if (hour24 > currentHour) {
                        currentIndex = Math.max(0, i - 1);
                        break;
                    }
                }
                
                const timeString = now.toLocaleTimeString('en-US', { 
                    hour: 'numeric', 
                    minute: '2-digit',
                    hour12: true 
                });
                const dataTime = data.labels[currentIndex];
                const isStale = !foundExactMatch;
                
                document.getElementById('current-time').innerHTML = 
                    `${timeString}${isStale ? ` <span class="text-orange-500">(showing ${dataTime})</span>` : ''}`;
                
                // Update current conditions (Now row)
                const temp = Math.round(data.temperature[currentIndex] || 0);
                const uv = (data.uv[currentIndex] || 0).toFixed(1);
                const precip = Math.round(data.precipitation[currentIndex] || 0);
                const humidity = Math.round(data.humidity[currentIndex] || 0);
                
                document.getElementById('current-temp-dual').textContent = `${temp}¬∞F`;
                document.getElementById('current-uv-dual').textContent = uv;
                document.getElementById('current-precip-dual').textContent = `${precip}%`;
                document.getElementById('current-humidity-dual').textContent = `${humidity}%`;
                
                // Color the dual display values
                const uvElementDual = document.getElementById('current-uv-dual');
                uvElementDual.style.color = getUVColor(parseFloat(uv));
                
                const tempElementDual = document.getElementById('current-temp-dual');
                tempElementDual.style.color = getTempLineColor(temp);
                
                // Fetch and update today's forecast (Today row)
                updateTodaysForecast();
                
            } else {
                headerElement.textContent = 'Daily Forecast';
                document.getElementById('current-time').textContent = 'High/Low for the day';
                
                // Show single display for future days
                document.getElementById('dual-display').classList.add('hidden');
                document.getElementById('single-display').classList.remove('hidden');
                
                // For future days, fetch and show daily summary
                updateDailySummary();
            }
        }

        // Function to update today's forecast in dual display
        async function updateTodaysForecast() {
            try {
                const url = `/api/daily-summary?lat=${currentLocation.lat}&lon=${currentLocation.lon}&date=${currentDate}`;
                const response = await fetch(url);
                const dailyData = await response.json();

                if (!response.ok) {
                    throw new Error(dailyData.error || 'Failed to load daily summary');
                }

                // Update today's forecast row
                const tempHigh = Math.round(dailyData.tempMax || 0);
                const tempLow = Math.round(dailyData.tempMin || 0);
                const uvMax = (dailyData.uvMax || 0).toFixed(1);
                const precipMax = Math.round(dailyData.precipMax || 0);

                document.getElementById('today-temp-dual').textContent = `${tempHigh}¬∞/${tempLow}¬∞F`;
                document.getElementById('today-uv-dual').textContent = uvMax;
                document.getElementById('today-precip-dual').textContent = `${precipMax}%`;

                // Color the today's forecast values
                const todayUvElement = document.getElementById('today-uv-dual');
                todayUvElement.style.color = getUVColor(parseFloat(uvMax));

                const todayTempElement = document.getElementById('today-temp-dual');
                todayTempElement.style.color = getTempLineColor(tempHigh);

            } catch (error) {
                console.error('Today forecast error:', error);
                // Set fallback values
                document.getElementById('today-temp-dual').textContent = '--¬∞/--¬∞F';
                document.getElementById('today-uv-dual').textContent = '--';
                document.getElementById('today-precip-dual').textContent = '--%';
            }
        }

        // Function to render charts with data
        function renderCharts(data) {
            // Update current conditions first
            updateCurrentConditions(data);
            
            // Destroy existing charts if they exist
            if (uvChart) {
                uvChart.destroy();
            }
            if (weatherChart) {
                weatherChart.destroy();
            }

            // Reset canvas dimensions to ensure proper rendering
            const uvCanvas = document.getElementById('uvChart');
            const weatherCanvas = document.getElementById('weatherChart');
            
            // Clear canvas style and reset dimensions
            uvCanvas.style.width = '100%';
            uvCanvas.style.height = '384px';
            uvCanvas.width = uvCanvas.offsetWidth;
            uvCanvas.height = 384;
            
            weatherCanvas.style.width = '100%';
            weatherCanvas.style.height = '384px';
            weatherCanvas.width = weatherCanvas.offsetWidth;
            weatherCanvas.height = 384;

            // Create UV chart
            const uvCtx = document.getElementById('uvChart').getContext('2d');
            uvChart = new Chart(uvCtx, {
                type: 'bar',
                data: {
                    labels: data.labels,
                    datasets: [{
                        label: 'UV Index',
                        data: data.uv,
                        backgroundColor: data.uv.map(value => getUVColor(value)),
                        borderColor: data.uv.map(value => getUVColor(value)),
                        borderWidth: 1,
                        borderRadius: 4,
                        borderSkipped: false
                    }, {
                        label: 'UV Index Clear Sky',
                        data: data.uvClearSky,
                        type: 'line',
                        borderColor: '#ef4444',
                        backgroundColor: 'transparent',
                        borderWidth: 2,
                        borderDash: [5, 5],
                        fill: false,
                        pointRadius: 0,
                        tension: 0.3
                    }]
                },
                options: {
                    responsive: false,
                    maintainAspectRatio: false,
                    animation: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                usePointStyle: true,
                                padding: 10,
                                font: {
                                    size: window.innerWidth < 640 ? 10 : 12
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const value = context.parsed.y;
                                    let level = 'Low';
                                    if (value > 10) level = 'Extreme';
                                    else if (value > 7) level = 'Very High';
                                    else if (value > 5) level = 'High';
                                    else if (value > 2) level = 'Moderate';
                                    const suffix = context.dataset.label.includes('Clear Sky') ? ' (Clear Sky)' : '';
                                    return `${context.dataset.label}: ${value} (${level})${suffix}`;
                                }
                            }
                        }
                    },
                    layout: {
                        padding: {
                            left: window.innerWidth < 640 ? 5 : 10,
                            right: window.innerWidth < 640 ? 5 : 10,
                            top: 10,
                            bottom: 10
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: Math.max(12, Math.max(...data.uv) + 1),
                            title: {
                                display: window.innerWidth >= 640,
                                text: 'UV Index'
                            },
                            ticks: {
                                font: {
                                    size: window.innerWidth < 640 ? 10 : 12
                                }
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.1)'
                            }
                        },
                        x: {
                            title: {
                                display: false
                            },
                            ticks: {
                                maxRotation: window.innerWidth < 640 ? 45 : 0,
                                font: {
                                    size: window.innerWidth < 640 ? 9 : 12
                                },
                                callback: function(value, index) {
                                    if (window.innerWidth < 640) {
                                        return index % 2 === 0 ? this.getLabelForValue(value) : '';
                                    }
                                    return this.getLabelForValue(value);
                                }
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.1)'
                            }
                        }
                    }
                }
            });

            // Create weather chart (Temperature & Precipitation)
            const weatherCtx = document.getElementById('weatherChart').getContext('2d');
            weatherChart = new Chart(weatherCtx, {
                type: 'line',
                data: {
                    labels: data.labels,
                    datasets: [{
                        label: 'Precipitation Probability (%)',
                        data: data.precipitation,
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.2)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.3,
                        yAxisID: 'y'
                    }, {
                        label: 'Cloud Cover (%)',
                        data: data.cloudCover,
                        type: 'bar',
                        borderColor: '#d1d5db',
                        backgroundColor: 'rgba(209, 213, 219, 0.6)',
                        borderWidth: 1,
                        yAxisID: 'y'
                    }, {
                        label: 'Temperature (¬∞F)',
                        data: data.temperature,
                        borderColor: USE_NEUTRAL_TEMP_LINE ? '#6b7280' : '#9ca3af',
                        backgroundColor: 'transparent',
                        borderWidth: 3,
                        fill: false,
                        tension: 0.3,
                        pointRadius: 0,
                        segment: {
                            borderColor: ctx => {
                                if (USE_NEUTRAL_TEMP_LINE) return undefined;
                                const y0 = ctx.p0?.parsed?.y;
                                const y1 = ctx.p1?.parsed?.y;
                                if (typeof y0 !== 'number' || typeof y1 !== 'number') return undefined;
                                const t = (y0 + y1) / 2;
                                return getTempLineColor(t);
                            }
                        },
                        yAxisID: 'y1'
                    }, {
                        label: 'Apparent Temperature (¬∞F)',
                        data: data.apparentTemperature,
                        borderColor: USE_NEUTRAL_TEMP_LINE ? '#374151' : '#6b7280',
                        backgroundColor: 'transparent',
                        borderWidth: 2,
                        borderDash: [5, 5],
                        fill: false,
                        tension: 0.3,
                        pointRadius: 0,
                        segment: {
                            borderColor: ctx => {
                                if (USE_NEUTRAL_TEMP_LINE) return undefined;
                                const y0 = ctx.p0?.parsed?.y;
                                const y1 = ctx.p1?.parsed?.y;
                                if (typeof y0 !== 'number' || typeof y1 !== 'number') return undefined;
                                const t = (y0 + y1) / 2;
                                return getTempLineColor(t);
                            }
                        },
                        yAxisID: 'y1'
                    }, {
                        label: 'Humidity (%)',
                        data: data.humidity,
                        borderColor: '#10b981',
                        backgroundColor: 'transparent',
                        borderWidth: 2,
                        borderDash: [2, 2],
                        fill: false,
                        tension: 0.3,
                        yAxisID: 'y'
                    }]
                },
                options: {
                    responsive: false,
                    maintainAspectRatio: false,
                    animation: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false
                        }
                    },
                    layout: {
                        padding: {
                            left: window.innerWidth < 640 ? 5 : 10,
                            right: window.innerWidth < 640 ? 5 : 10,
                            top: 10,
                            bottom: 10
                        }
                    },
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            beginAtZero: true,
                            max: 100,
                            title: {
                                display: window.innerWidth >= 640,
                                text: 'Percentage'
                            },
                            ticks: {
                                font: {
                                    size: window.innerWidth < 640 ? 10 : 12
                                }
                            },
                            grid: {
                                color: 'rgba(59, 130, 246, 0.1)'
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: window.innerWidth >= 640,
                                text: 'Temperature (¬∞F)'
                            },
                            ticks: {
                                font: {
                                    size: window.innerWidth < 640 ? 10 : 12
                                }
                            },
                            grid: {
                                drawOnChartArea: false
                            }
                        },
                        x: {
                            title: {
                                display: false
                            },
                            ticks: {
                                maxRotation: window.innerWidth < 640 ? 45 : 0,
                                font: {
                                    size: window.innerWidth < 640 ? 9 : 12
                                },
                                callback: function(value, index) {
                                    if (window.innerWidth < 640) {
                                        return index % 2 === 0 ? this.getLabelForValue(value) : '';
                                    }
                                    return this.getLabelForValue(value);
                                }
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.1)'
                            }
                        }
                    }
                }
            });
        }

        // Function to get location name from coordinates
        async function getLocationName(lat, lon) {
            try {
                const response = await fetch(`https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${lat}&longitude=${lon}&localityLanguage=en`);
                const data = await response.json();
                
                if (data.city && data.principalSubdivision) {
                    return `${data.city}, ${data.principalSubdivision}`;
                } else if (data.locality && data.principalSubdivision) {
                    return `${data.locality}, ${data.principalSubdivision}`;
                } else if (data.countryName) {
                    return data.countryName;
                }
                return 'Your Location';
            } catch (error) {
                console.log('Geocoding error:', error);
                return 'Your Location';
            }
        }

        async function getCurrentLocation() {
            return new Promise((resolve) => {
                if (!navigator.geolocation) {
                    console.log('Geolocation not supported');
                    resolve(null);
                    return;
                }

                const options = {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 300000 // 5 minutes
                };

                navigator.geolocation.getCurrentPosition(
                    async (position) => {
                        const locationName = await getLocationName(position.coords.latitude, position.coords.longitude);
                        resolve({
                            lat: position.coords.latitude,
                            lon: position.coords.longitude,
                            name: locationName,
                            isUserLocation: true
                        });
                    },
                    (error) => {
                        console.log('Geolocation error:', error.message);
                        resolve(null);
                    },
                    options
                );
            });
        }

        async function loadUVData(date = currentDate, skipPolling = false) {
            console.log('Loading UV data for date:', date);
            try {
                // Try to get user's location
                const userLocation = await getCurrentLocation();
                
                if (userLocation) {
                    currentLocation = userLocation;
                } else {
                    console.log('Using default location: Summit, NJ');
                }

                // Update location display with icon
                const locationIcon = currentLocation.isUserLocation ? 'üìç ' : '';
                document.getElementById('location-display').textContent = 
                    `${locationIcon}${currentLocation.name}`;

                // Fetch UV data for current location and date
                const url = `/api/uv-today?lat=${currentLocation.lat}&lon=${currentLocation.lon}&date=${date}`;
                const response = await fetch(url);
                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Failed to load UV data');
                }

                // Extract metadata if present
                const metadata = data.metadata || {};
                const actualData = metadata.cached !== undefined ? 
                    { ...data, metadata: undefined } : data;
                
                // Update timestamp for polling
                if (metadata.lastUpdated) {
                    currentDataTimestamp = new Date(metadata.lastUpdated).getTime();
                }

                // Format and display date
                const dateObj = new Date(actualData.date + 'T00:00:00');
                const dateDisplay = dateObj.toLocaleDateString('en-US', { 
                    weekday: 'long', 
                    month: 'long', 
                    day: 'numeric' 
                });
                document.getElementById('date-display').textContent = dateDisplay;

                // Hide loading, show charts and current conditions
                document.getElementById('loading').style.display = 'none';
                document.getElementById('current-conditions').classList.remove('hidden');
                document.getElementById('chart-container').classList.remove('hidden');
                document.getElementById('weather-chart-container').classList.remove('hidden');
                document.getElementById('legend').classList.remove('hidden');

                // Render charts with data
                renderCharts(actualData);
                
                // Start appropriate polling based on data freshness
                if (date === currentDate && !skipPolling) {
                    if (metadata.cached) {
                        console.log('Data was cached, starting exponential backoff polling...');
                        startPolling(date, true);
                    } else {
                        console.log('Data was fresh, starting hourly polling...');
                        startPolling(date, false);
                    }
                }

                // [This entire block removed since it's now handled by renderCharts()]

            } catch (error) {
                // Hide loading, show error
                document.getElementById('loading').style.display = 'none';
                document.getElementById('error').classList.remove('hidden');
                document.getElementById('error-message').textContent = error.message;
            }
        }

        // PWA Service Worker Registration
        let refreshing = false;
        
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => {
                        console.log('SW registered: ', registration);
                        
                        // Check for updates
                        registration.addEventListener('updatefound', () => {
                            const newWorker = registration.installing;
                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    // New version available
                                    showUpdateNotification();
                                }
                            });
                        });
                    })
                    .catch(registrationError => {
                        console.log('SW registration failed: ', registrationError);
                    });
                
                // Handle controller change (new SW activated)
                navigator.serviceWorker.addEventListener('controllerchange', () => {
                    if (refreshing) return;
                    refreshing = true;
                    window.location.reload();
                });
            });
        }
        
        // Show update notification
        function showUpdateNotification() {
            // Check if notification already exists
            if (document.getElementById('update-notification')) return;
            
            const updateBar = document.createElement('div');
            updateBar.id = 'update-notification';
            updateBar.className = 'fixed top-0 left-0 right-0 bg-blue-500 text-white p-3 text-center z-50 shadow-lg';
            updateBar.innerHTML = `
                <div class="flex items-center justify-center space-x-4">
                    <span>üöÄ New version available!</span>
                    <button onclick="forceUpdate()" class="bg-white text-blue-500 px-3 py-1 rounded text-sm font-medium hover:bg-gray-100">
                        Update Now
                    </button>
                    <button onclick="dismissUpdate()" class="text-blue-200 hover:text-white text-sm">
                        Later
                    </button>
                </div>
            `;
            document.body.insertBefore(updateBar, document.body.firstChild);
        }
        
        // Force update
        function forceUpdate() {
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.ready.then(registration => {
                    if (registration.waiting) {
                        registration.waiting.postMessage({type: 'SKIP_WAITING'});
                    }
                });
            }
        }
        
        // Dismiss update notification
        function dismissUpdate() {
            const notification = document.getElementById('update-notification');
            if (notification) {
                notification.remove();
            }
        }

        // Polling functionality
        let pollTimeout = null;
        let currentPollDelay = 500; // Current delay for this polling session
        const MAX_POLL_DELAY = 3600000; // 1 hour
        const HOURLY_POLL_DELAY = 3600000; // 1 hour for fresh data
        
        async function startPolling(date, isCachedData = true) {
            // Clear any existing polling
            stopPolling();
            
            // Set initial delay based on whether data was cached
            if (!isCachedData) {
                // If data was fresh, just check hourly
                currentPollDelay = HOURLY_POLL_DELAY;
                console.log('Starting hourly polling for fresh data');
            } else {
                // If data was cached, start with exponential backoff
                currentPollDelay = 500; // Reset to 0.5 seconds
                console.log('Starting exponential backoff polling from 0.5 seconds');
            }
            
            schedulePoll(date, isCachedData);
        }
        
        function schedulePoll(date, isExponentialBackoff) {
            console.log(`Scheduling next poll in ${currentPollDelay/1000} seconds`);
            pollTimeout = setTimeout(async () => {
                try {
                    const pollUrl = `/api/uv-today/poll?lat=${currentLocation.lat}&lon=${currentLocation.lon}&date=${date}&timestamp=${currentDataTimestamp}`;
                    const response = await fetch(pollUrl);
                    const pollData = await response.json();
                    
                    if (pollData.hasUpdate) {
                        console.log('New data available, fetching update...');
                        // Stop polling while updating
                        stopPolling();
                        
                        // Fetch fresh data but skip polling restart to avoid reset loop
                        await loadUVData(date, true);
                        
                        // After background update, the data should be fresh, so switch to hourly polling
                        if (date === currentDate) {
                            console.log('Update complete, switching to hourly polling');
                            startPolling(date, false);
                        }
                    } else {
                        // No update, schedule next poll
                        if (isExponentialBackoff && currentPollDelay < MAX_POLL_DELAY) {
                            // Double the delay for exponential backoff
                            currentPollDelay = Math.min(currentPollDelay * 2, MAX_POLL_DELAY);
                            console.log(`No update yet, backing off to ${currentPollDelay/1000} seconds`);
                        }
                        // Schedule next poll
                        schedulePoll(date, isExponentialBackoff);
                    }
                } catch (error) {
                    console.error('Polling error:', error);
                    // On error, continue polling but don't change the delay
                    schedulePoll(date, isExponentialBackoff);
                }
            }, currentPollDelay);
        }
        
        function stopPolling() {
            if (pollTimeout) {
                clearTimeout(pollTimeout);
                pollTimeout = null;
            }
        }

        // Date navigation functions
        function navigateDate(direction) {
            // Parse date properly to avoid timezone issues
            const [year, month, day] = currentDate.split('-').map(Number);
            const date = new Date(year, month - 1, day); // month is 0-indexed
            date.setDate(date.getDate() + direction);
            
            // Check bounds - don't go before today (use local timezone)
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            // Don't go beyond 16 days from today
            const maxDate = new Date(today);
            maxDate.setDate(maxDate.getDate() + 16);

            console.log('currentDate:', currentDate);
            console.log('navigating to date:', date);
            console.log('today:', today);
            console.log('maxDate:', maxDate);
            
            if (date >= today && date <= maxDate) {
                currentDate = date.toLocaleDateString('en-CA');
                updateNavigationButtons();
                
                // Stop polling when changing dates
                stopPolling();
                
                // Show loading state
                document.getElementById('loading').style.display = 'block';
                document.getElementById('current-conditions').classList.add('hidden');
                document.getElementById('chart-container').classList.add('hidden');
                document.getElementById('weather-chart-container').classList.add('hidden');
                document.getElementById('legend').classList.add('hidden');
                
                loadUVData(currentDate);
            }
        }

        function updateNavigationButtons() {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const maxDate = new Date(today);
            maxDate.setDate(maxDate.getDate() + 16);
            
            // Parse current date properly to avoid timezone issues
            const [year, month, day] = currentDate.split('-').map(Number);
            const current = new Date(year, month - 1, day);
            
            // Disable/enable buttons based on date limits
            const prevBtn = document.getElementById('prev-day');
            const nextBtn = document.getElementById('next-day');
            
            prevBtn.disabled = current <= today;
            nextBtn.disabled = current >= maxDate;
            
            // Update button styles
            prevBtn.className = current <= today 
                ? 'text-gray-300 mr-2 text-lg cursor-not-allowed' 
                : 'text-gray-600 hover:text-gray-800 mr-2 text-lg cursor-pointer';
            nextBtn.className = current >= maxDate 
                ? 'text-gray-300 ml-2 text-lg cursor-not-allowed' 
                : 'text-gray-600 hover:text-gray-800 ml-2 text-lg cursor-pointer';
        }

        // Add event listeners for navigation
        document.getElementById('prev-day').addEventListener('click', () => navigateDate(-1));
        document.getElementById('next-day').addEventListener('click', () => navigateDate(1));

        // Load data when page loads
        loadUVData().then(() => {
            updateNavigationButtons();
        });
    </script>
    
    <!-- UV Index Guide -->
    <div class="max-w-4xl mx-auto px-4 py-8">
        <h2 class="text-2xl font-bold mb-6 text-gray-800">UV Index Protection Guide</h2>
        
        <div class="space-y-4">
            <!-- Low (0-2) -->
            <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                <div class="flex items-center mb-2">
                    <div class="w-4 h-4 bg-green-500 rounded mr-3"></div>
                    <h3 class="font-semibold text-lg">Low (0-2)</h3>
                </div>
                <p class="text-gray-700 mb-2">Minimal sun protection required for normal activity.</p>
                <ul class="list-disc list-inside text-sm text-gray-600 space-y-1">
                    <li>Wear sunglasses on bright days</li>
                    <li>If you burn easily, cover up and use SPF 15+ sunscreen</li>
                    <li>Snow/water reflection can nearly double UV strength</li>
                </ul>
            </div>
            
            <!-- Moderate (3-5) -->
            <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                <div class="flex items-center mb-2">
                    <div class="w-4 h-4 bg-yellow-500 rounded mr-3"></div>
                    <h3 class="font-semibold text-lg">Moderate (3-5)</h3>
                </div>
                <p class="text-gray-700 mb-2">Protection required. Take precautions if outside.</p>
                <ul class="list-disc list-inside text-sm text-gray-600 space-y-1">
                    <li>Stay in shade near midday when sun is strongest</li>
                    <li>Apply SPF 30+ broad-spectrum sunscreen every 2 hours</li>
                    <li>Wear protective clothing, wide-brimmed hat, and UV-blocking sunglasses</li>
                    <li>Unprotected skin burns in 30-45 minutes</li>
                </ul>
            </div>
            
            <!-- High (6-7) -->
            <div class="bg-orange-50 border border-orange-200 rounded-lg p-4">
                <div class="flex items-center mb-2">
                    <div class="w-4 h-4 bg-orange-500 rounded mr-3"></div>
                    <h3 class="font-semibold text-lg">High (6-7)</h3>
                </div>
                <p class="text-gray-700 mb-2">Extra protection required. Unprotected skin and eyes will be damaged.</p>
                <ul class="list-disc list-inside text-sm text-gray-600 space-y-1">
                    <li>Reduce time in sun between 10am-4pm</li>
                    <li>Apply SPF 30+ broad-spectrum sunscreen liberally and reapply every 2 hours</li>
                    <li>Seek shade, wear protective clothing, wide-brimmed hat, and sunglasses</li>
                    <li>Unprotected skin burns in 15-25 minutes</li>
                </ul>
            </div>
            
            <!-- Very High (8-10) -->
            <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                <div class="flex items-center mb-2">
                    <div class="w-4 h-4 bg-red-500 rounded mr-3"></div>
                    <h3 class="font-semibold text-lg">Very High (8-10)</h3>
                </div>
                <p class="text-gray-700 mb-2">Extra protection essential. Unprotected skin can burn quickly.</p>
                <ul class="list-disc list-inside text-sm text-gray-600 space-y-1">
                    <li>Minimize sun exposure between 10am-4pm</li>
                    <li>Apply SPF 50+ broad-spectrum sunscreen every 2 hours and after swimming</li>
                    <li>Shirt, sunglasses, and hat essential. Seek shade whenever possible</li>
                    <li>Unprotected skin burns in 10-15 minutes</li>
                    <li>Beach sand and water reflect UV, increasing exposure</li>
                </ul>
            </div>
            
            <!-- Extreme (11+) -->
            <div class="bg-purple-50 border border-purple-200 rounded-lg p-4">
                <div class="flex items-center mb-2">
                    <div class="w-4 h-4 bg-purple-600 rounded mr-3"></div>
                    <h3 class="font-semibold text-lg">Extreme (11+)</h3>
                </div>
                <p class="text-gray-700 mb-2">Maximum protection required. Unprotected skin burns in minutes.</p>
                <ul class="list-disc list-inside text-sm text-gray-600 space-y-1">
                    <li>Avoid sun exposure between 10am-4pm</li>
                    <li>Apply SPF 50+ broad-spectrum sunscreen every 2 hours minimum</li>
                    <li>Full coverage clothing, UV-blocking sunglasses, and wide hat mandatory</li>
                    <li>Unprotected skin burns in less than 10 minutes</li>
                    <li>Seek shade and limit all outdoor activities during peak hours</li>
                </ul>
            </div>
        </div>
        
        <div class="mt-6 p-4 bg-blue-50 border border-blue-200 rounded-lg">
            <h4 class="font-semibold mb-2">Sunscreen Application Tips:</h4>
            <ul class="list-disc list-inside text-sm text-gray-600 space-y-1">
                <li>Apply 1 ounce (shot glass full) to cover entire body</li>
                <li>Apply 15-30 minutes before sun exposure</li>
                <li>Reapply after swimming, sweating, or towel drying</li>
                <li>Use water-resistant sunscreen if swimming or sweating</li>
                <li>Don't forget ears, feet, back of neck, and hands</li>
                <li>Check expiration dates - sunscreen loses effectiveness over time</li>
            </ul>
        </div>
    </div>
</body>
</html>